var _init=!1,_real=!0,_render=!0;_env=!0,_tooltip=!1,_mobile=!1,_sound=!1,_first=!0,d=document,w=window,assets="/assets/";var container,loader,info,stats,scene,camera,renderer,controls,light,underlight,ambientLight,sound,soundOutsideAnalyser,raycaster,INTERSECTED,labelRenderer,underRenderer,water,skybox,mesh,underwater,mixer=!1,clock=new THREE.Clock,mouse=new THREE.Vector2,DEGTORAD=.01745327,parameters={oceanSide:1e3,size:1,distortionScale:1,alpha:.9};function isMobileDevice(){return void 0!==w.orientation||-1!==navigator.userAgent.indexOf("IEMobile")}function clear(e){for(var a in controls.reset(),_first=!0,_sound&&(sound.stop(),_sound=!1),loader.meshes){for(var r=loader.meshes[a].children.length-1;r>=0;r--)loader.meshes[a].remove(loader.meshes[a].children[r]);if(scene.remove(loader.meshes[a]),Array.isArray(loader.meshes[a].material))for(r=loader.meshes[a].material.length-1;r>=0;r--)loader.meshes[a].material[r].dispose();else loader.meshes[a].material.dispose();loader.meshes[a].geometry.dispose()}for(var a in loader.containers)scene.remove(loader.containers[a]);for(var a in loader.sounds3d)loader.sounds3d[a].stop(),scene.remove(loader.sounds3d[a]);e?(_render=!0,load()):_render=!1}function load(){info.style.display="flex",_render=!1,loader=new THREE.SEA3D({container:scene,autoPlay:!0});const e=renderer.capabilities.getMaxAnisotropy();void 0,loader.onComplete=function(a){if(loader.config.container.traverse((function(a){a.isMesh&&""!=a.name&&("Girl01"==a.name&&(mesh=a),void 0,a.material.map&&(a.material.map.anisotropy=e),a.material.transparent)})),_first){if(setTimeout((function(){toggleBaseColor(),_render=!0,info.style.display="none"}),400),loader.properties)for(var r of(void 0,loader.properties))r.model&&loader.load(assets+"models/inc/"+r.model+".sea")}else for(var r of loader.properties)if(r.model){var t=scene.getObjectByName(r.mesh,!0);t&&(r.roty&&t.rotateY(Math.PI),r.rotz&&t.rotateZ(Math.PI/(180-r.rotz)),t.position.set(r.posx,r.posy,r.posz))}_first=!1};var a=w.parent.onw3d.model||"404",r=w.parent.onw3d.equip||"",t=assets+"models/"+a+r+".sea",n=new XMLHttpRequest;n.onreadystatechange=function(){4===n.readyState&&(404===n.status?(w.parent.onw3d.model="404",w.parent.onw3d.setPreloader(),loader.load(assets+"models/404.sea")):(w.parent.onw3d.setPreloader(!0),loader.load(t)))},n.open("HEAD",t),n.send()}function init(){if(_init)return clear(!0);_mobile=isMobileDevice(),_real=!_mobile,_mobile&&(d.body.className="mobile",w.parent.onw3d.toggleMobile(!0));var e=w.innerWidth,a=w.innerHeight;container=d.createElement("div"),d.body.appendChild(container),(renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0})).antialias=!0,renderer.setPixelRatio(w.devicePixelRatio),renderer.setSize(e,a),container.appendChild(renderer.domElement),(labelRenderer=new THREE.CSS2DRenderer).setSize(e,a),labelRenderer.domElement.className="label-frame",container.appendChild(labelRenderer.domElement),(scene=new THREE.Scene).fog=new THREE.FogExp2(4148570,.001),(camera=new THREE.PerspectiveCamera(55,e/a,1,2e4)).position.set(0,30,80),(light=new THREE.DirectionalLight(16777215,1.3)).position.set(-30,30,30),light.castShadow=!0,light.shadow.camera.scale.set(5,3,4),scene.add(light),(underlight=new THREE.DirectionalLight(13421772,.4)).position.set(30,-30,30),scene.add(underlight),ambientLight=new THREE.AmbientLight(15658734,1),scene.add(ambientLight),(controls=new THREE.OrbitControls(camera,renderer.domElement)).target.set(0,0,0),controls.maxDistance=200,controls.enableDamping=!0,controls.dampingFactor=.2,controls.zoomSpeed=.4,controls.rotateSpeed=.3,controls.autoRotate=!0,controls.autoRotateSpeed=.6,camera.lookAt(controls.target),stats=new Stats,container.appendChild(stats.dom),stats.dom.style.opacity="0.05",d.addEventListener("mousemove",onDocumentMouseMove,!1),w.addEventListener("resize",onWindowResize,!1),_init=!0,_env&&(setWater(),setSkybox()),load(),animate()}function onDocumentMouseMove(e){e.preventDefault(),mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1}function toggleCameraRotate(){controls.autoRotate=1!=controls.autoRotate}function toggleTooltips(){_tooltip=!_tooltip}function toggleBaseColor(e){e||(e=!1);var a,r,t="disable",n="green",o="grey",s=w.parent.onw3d.color,i=w.parent.onw3d.getGoods();function l(e,a){var r,t=e.geometry.boundingSphere.center,n=d.createElement("div");n.className="label",n.innerHTML=a,n.style.display="none",(r=new THREE.CSS2DObject(n)).position.set(t.x,t.y+1,t.z),e.add(r),_tooltip=!0}loader.meshes?(renderer.shadowMap.enabled=!1,!e&&loader.properties&&setSound(),loader.meshes.forEach((function(d,c,m){if(!e){var p,E="",u=d.geometry.name;if("Veslo_Excluded"==u&&l(d,'<div class="mesh-info warning"><span>Весло в комплект не входит!</span></div>'),"Motor_Geom"==u&&l(d,'<div class="mesh-info warning"><span>Двигатель в комплект не входит!</span></div>'),u.search(/_ID/i)>0){p=d.material.clone(),d.material=p;var h=u.substring(u.lastIndexOf("-")+1);for(var f in i)if(i[f].id==h){l(d,'<div class="mesh-info"><span>'+i[f].name+": </span><b>$"+parseInt(i[f].price)+"</b></div>");break}}raycaster=new THREE.Raycaster}if(d.name.search(/_Base_Mesh/i)>0){!function(e){const a=(new THREE.Box3).setFromObject(e),r=a.getSize(new THREE.Vector3),t=(a.getCenter(new THREE.Vector3),Math.max(r.x,r.y,r.z)/(2*Math.atan(Math.PI*camera.fov/360))),n=t/camera.aspect,o=.7*Math.max(t,n),s=controls.target.clone().sub(camera.position).normalize().multiplyScalar(o);new TWEEN.Tween(camera.position).to({x:-s.x,y:-s.y,z:-s.z},2e3).easing(TWEEN.Easing.Cubic.Out).start()}(d),d.receiveShadow=!0,p=d.material;try{E=p.map.image.src}catch(e){void 0}e?(e==n?(a=o,r=n):e==o&&(a=n,r=o),p.map.dispose(),p.map.image.src=E.replace(r,a),p.needsUpdate=!0,s=a,t=r):s?(s==n?(a=n,r=o):s==o&&(a=o,r=n),p.map.dispose(),p.map.image.src=E.replace(r,a),p.needsUpdate=!0,s=a,t=r):(E.search(/green/i)>0?(a=o,r=n):E.search(/grey/i)>0&&(a=n,r=o),s=r,t=a),w.parent.onw3d.color=s}}))):_tooltip=!1,w.parent.onw3d.toggleColorBtn(t)}function setEnv(){water||setWater(),skybox||setSkybox(),1==_env?(_env=!1,skybox&&(skybox.visible=!1),water&&(water.visible=!1)):(_env=!0,_real=!0,skybox&&(skybox.visible=!0),water&&(water.visible=!0))}function setWater(){(water=new THREE.Water(new THREE.PlaneBufferGeometry(1*parameters.oceanSide,1*parameters.oceanSide),{textureWidth:512,textureHeight:512,waterNormals:(new THREE.TextureLoader).load(assets+"textures/waternormals.jpg",(function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping})),alpha:parameters.alpha,sunDirection:light.position.clone().normalize(),sunColor:16777215,waterColor:7695,distortionScale:parameters.distortionScale,fog:void 0!==scene.fog,side:THREE.DoubleSide})).position.y=-1.5,water.rotation.x=-Math.PI/2,water.receiveShadow=!1,scene.add(water);var e=new THREE.BoxBufferGeometry(parameters.oceanSide,parameters.oceanSide,parameters.oceanSide),a=new THREE.MeshBasicMaterial({transparent:!0,opacity:.75,color:2902101,side:THREE.BackSide,depthTest:!0});(underwater=new THREE.Mesh(e,a)).position.y=-parameters.oceanSide/2-1.501,underwater.rotation.x=-Math.PI/2,scene.add(underwater)}function setSkybox(){var e=new THREE.CubeTextureLoader;e.setPath(assets+"textures/skybox4/"),cubeMap=e.load(["px.jpg","nx.jpg","py.jpg","ny.jpg","pz.jpg","nz.jpg"]);var a=THREE.ShaderLib.cube;a.uniforms.tCube.value=cubeMap;var r=new THREE.ShaderMaterial({fragmentShader:a.fragmentShader,vertexShader:a.vertexShader,uniforms:a.uniforms,side:THREE.BackSide}),t=new THREE.BoxBufferGeometry(5*parameters.oceanSide+100,5*parameters.oceanSide+100,5*parameters.oceanSide+100);skybox=new THREE.Mesh(t,r),scene.add(skybox)}function setSound(){var e=loader.properties[0].sound_url;if(e){var a=loader.properties[0].sound_mesh,r=new THREE.AudioListener;camera.add(r),sound=new THREE.PositionalAudio(r);var t=new THREE.AudioLoader;t.load(e,(function(e){sound.setBuffer(e),sound.setLoop(!0),sound.setRefDistance(5),sound.play()})),a.add(sound);var n=new THREE.PositionalAudio(r);t.load(assets+"sounds/water.mp3",(function(e){n.setBuffer(e),n.setLoop(!0),n.setRefDistance(2),n.play()})),loader.getMesh("Sphere001").receiveShadow=!1,soundOutsideAnalyser=new THREE.AudioAnalyser(sound,32),loader.properties[0].shadows&&(renderer.shadowMap.enabled=!0),_sound=!0}}function updateSoundFilter(){}function takeScreenshot(){var e=d.createElement("a");renderer.render(scene,camera),e.href=renderer.domElement.toDataURL().replace("image/png","image/octet-stream"),e.download=w.parent.onw3d.model+".png",d.body.appendChild(e),e.click(),d.body.removeChild(e)}function onWindowResize(){var e=w.innerWidth,a=w.innerHeight;camera.aspect=e/a,camera.updateProjectionMatrix(),renderer.setSize(e,a),labelRenderer.setSize(e,a)}function animate(){requestAnimationFrame(animate);var e=null;if(_render){if(_tooltip&&(raycaster.setFromCamera(mouse,camera),e=raycaster.intersectObjects(loader.meshes)),e&&e.length>0){if(e[0].object!=INTERSECTED){if(INTERSECTED){INTERSECTED.material.blending=1,labelRenderer.domElement.className="label-frame";for(var a=INTERSECTED.children.length-1;a>=0;a--)INTERSECTED.children[a].element&&(INTERSECTED.children[a].element.style.display="none")}var r=(INTERSECTED=e[0].object).geometry.name;if(r.search(/_ID/i)>0||"Motor_Geom"==r||"Veslo_Excluded"==r){INTERSECTED.material.blending=3;for(a=INTERSECTED.children.length-1;a>=0;a--)INTERSECTED.children[a].element&&(INTERSECTED.children[a].element.style.display="block");labelRenderer.domElement.className="label-frame active"}}}else{if(INTERSECTED){INTERSECTED.material.blending=1;for(a=INTERSECTED.children.length-1;a>=0;a--)INTERSECTED.children[a].element&&(INTERSECTED.children[a].element.style.display="none")}INTERSECTED=null}_sound,_real&&_env&&(water.material.uniforms.time.value+=1/60),camera.position.y<-1.04?(underwater.renderOrder=999,underwater.material.depthTest=!1):(underwater.renderOrder=0,underwater.material.depthTest=!0),renderer.render(scene,camera),labelRenderer.render(scene,camera),controls.update(),stats.update(),TWEEN.update();var t=clock.getDelta();THREE.SEA3D.AnimationHandler.update(t)}}info=d.getElementById("info"),WEBGL.isWebGL2Available()||d.body.appendChild(WEBGL.getWebGL2ErrorMessage()),WEBGL.isWebGLAvailable()||d.body.appendChild(WEBGL.getWebGLErrorMessage()),d.addEventListener("visibilitychange",(function(){"hidden"===d.visibilityState?_render=!1:setTimeout((function(){_render=!0}),400)}),!1);